fetch('test.xlsx')
    .then(response => response.arrayBuffer())
    .then(data => {
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetNames = workbook.SheetNames;

        const categoryButtonsDiv = document.getElementById('categoryButtons');
        const productListDiv = document.getElementById('productList');
        productListDiv.innerHTML = ''; // 清空现有数据
        categoryButtonsDiv.innerHTML = ''; // 清空按钮

        // 创建按钮
        sheetNames.forEach(sheetName => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary m-2';
            button.textContent = sheetName;
            button.onclick = () => loadProducts(sheetName);
            categoryButtonsDiv.appendChild(button);
        });

        // 默认显示第一个sheet的产品
        if (sheetNames.length > 0) {
            loadProducts(sheetNames[0]);
        }

        // 加载产品信息
        function loadProducts(sheetName) {
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            productListDiv.innerHTML = ''; // 清空现有卡片

            // 按照英文描述分组
            const products = {};

            rows.slice(1).forEach(row => {
                const englishDescription = row[6] || '';
                if (!products[englishDescription]) {
                    products[englishDescription] = [];
                }

                products[englishDescription].push({
                    model: row[1] || '',
                    chineseDescription: row[3] || '',
                    wholesalePriceRMB: row[4] || '',
                    wholesalePriceUSD: row[5] || '',
                    productImage: row[0] ? `picture/${sheetName}/${row[0]}.png` : 'default-image.png'
                });
            });

            // 创建产品卡片
            Object.keys(products).forEach(englishDescription => {
                const productGroup = products[englishDescription];

                const card = document.createElement('div');
                card.className = 'col';
                let productCardHtml = `
                    <div class="card product-card shadow-sm">
                        <img src="${productGroup[0].productImage}" class="card-img-top" alt="Product Image" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="${productGroup[0].productImage}">
                        <div class="card-body">
                            <h5 class="card-title">${englishDescription}</h5>
                            <select class="form-select" id="modelSelect-${englishDescription}">
                                ${productGroup.map(product => `<option value="${product.model}">${product.model}</option>`).join('')}
                            </select>
                            <p class="card-text" id="priceRMB-${englishDescription}">价格（人民币）：¥${productGroup[0].wholesalePriceRMB}</p>
                            <p class="card-text" id="priceUSD-${englishDescription}">价格（美元）：$${productGroup[0].wholesalePriceUSD}</p>
                            <p class="card-text" id="chineseDesc-${englishDescription}">${productGroup[0].chineseDescription}</p>
                        </div>
                    </div>
                `;
                card.innerHTML = productCardHtml;
                productListDiv.appendChild(card);

                // 更新价格和描述
                const modelSelect = document.getElementById(`modelSelect-${englishDescription}`);
                modelSelect.addEventListener('change', (event) => {
                    const selectedModel = event.target.value;
                    const selectedProduct = productGroup.find(product => product.model === selectedModel);

                    document.getElementById(`priceRMB-${englishDescription}`).textContent = `价格（人民币）：¥${selectedProduct.wholesalePriceRMB}`;
                    document.getElementById(`priceUSD-${englishDescription}`).textContent = `价格（美元）：$${selectedProduct.wholesalePriceUSD}`;
                    document.getElementById(`chineseDesc-${englishDescription}`).textContent = selectedProduct.chineseDescription;
                });
            });

            // 延迟绑定图片点击事件
            setTimeout(() => {
                const modalImage = document.getElementById('modalImage');
                const images = document.querySelectorAll('.product-card img');
                images.forEach(image => {
                    image.addEventListener('click', () => {
                        const imageUrl = image.getAttribute('data-image');
                        modalImage.src = imageUrl;
                    });
                });
            }, 100); // 延迟100ms后再绑定
        }
    })
    .catch(error => {
        console.error('读取 Excel 文件时出错:', error);
    });
