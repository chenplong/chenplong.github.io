<script>
    let products = {}; // 将 products 定义为全局变量

    fetch('test.xlsx')
        .then(response => response.arrayBuffer())
        .then(data => {
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetNames = workbook.SheetNames;

            const categoryButtonsDiv = document.getElementById('categoryButtons');
            const productListDiv = document.getElementById('productList');
            categoryButtonsDiv.innerHTML = ''; // 清空按钮区域
            productListDiv.innerHTML = ''; // 清空产品列表区域

            // 创建分类按钮
            sheetNames.forEach(sheetName => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary m-2';
                button.textContent = sheetName;
                button.onclick = () => loadProducts(sheetName);
                categoryButtonsDiv.appendChild(button);
            });

            // 默认加载第一个分类的产品
            if (sheetNames.length > 0) {
                loadProducts(sheetNames[0]);
            }

            // 加载指定分类的产品
            function loadProducts(sheetName) {
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                products = {}; // 重置全局 products 对象

                // 解析 Excel 数据并填充 products 对象
                rows.slice(1).forEach(row => {
                    const model = row[1] || '';
                    const chineseDescription = row[3] || '';
                    const wholesalePriceRMB = row[4] || '';
                    const wholesalePriceUSD = row[5] || '';
                    const englishDescription = row[6] || '';
                    const imageSrc = row[0] ? `picture/${sheetName}/${row[0]}.png` : 'default-image.png';

                    if (!products[englishDescription]) {
                        products[englishDescription] = {
                            modelOptions: [],
                            imageSrc: imageSrc,
                            chineseDescription: chineseDescription,
                            englishDescription: englishDescription,
                            priceRMB: wholesalePriceRMB,
                            priceUSD: wholesalePriceUSD
                        };
                    }

                    products[englishDescription].modelOptions.push({
                        model: model,
                        priceRMB: wholesalePriceRMB,
                        priceUSD: wholesalePriceUSD,
                        chineseDescription: chineseDescription
                    });
                });

                // 清空现有的产品列表
                productListDiv.innerHTML = '';

                // 创建产品卡片
                Object.values(products).forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'col';
                    card.innerHTML = `
                        <div class="card product-card shadow-sm">
                            <img src="${product.imageSrc}" alt="Product Image" class="card-img-top" onerror="this.onerror=null;this.src='default-image.png';">
                            <div class="card-body">
                                <h5 class="card-title">${product.englishDescription}</h5>
                                <p class="card-text">${product.chineseDescription}</p>
                                <select class="form-select">
                                    <option value="">选择型号</option>
                                    ${product.modelOptions.map(option => `
                                        <option value="${option.model}" data-price-rmb="${option.priceRMB}" data-price-usd="${option.priceUSD}" data-description="${option.chineseDescription}">${option.model}</option>
                                    `).join('')}
                                </select>
                                <p class="productPrice card-text mt-3"><strong>Price:</strong> ¥${product.priceRMB} / $${product.priceUSD}</p>
                                <p class="productDescription card-text">${product.chineseDescription}</p>
                            </div>
                        </div>
                    `;
                    productListDiv.appendChild(card);

                    // 获取刚添加的 <select> 元素
                    const modelSelect = card.querySelector('select');
                    // 为 <select> 元素添加 change 事件监听器
                    modelSelect.addEventListener('change', function() {
                        updatePriceAndDescription(this);
                    });
                });
            }

            // 更新价格和描述信息
            function updatePriceAndDescription(selectElement) {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const priceRMB = selectedOption.getAttribute('data-price-rmb');
                const priceUSD = selectedOption.getAttribute('data-price-usd');
                const description = selectedOption.getAttribute('data-description');

                const cardBody = selectElement.closest('.card-body');
                const priceElement = cardBody.querySelector('.productPrice');
                const descriptionElement = cardBody.querySelector('.productDescription');

                if (priceElement && descriptionElement) {
                    priceElement.innerHTML = `<strong>Price:</strong> ¥${priceRMB} / $${priceUSD}`;
                    descriptionElement.textContent = description;
                }
            }
        })
        .catch(error => {
            console.error('读取 Excel 文件时出错:', error);
        });
</script>
